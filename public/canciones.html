<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AttoMusic - Canciones por Género</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <link rel="shortcut icon" href="images/icono.png" type="image/x-icon">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap" rel="stylesheet">
</head>
<body>

<div id="nav-generos" style="max-width:1100px;margin:32px auto 0 auto;">
  <h2 style="color:#5a189a;font-weight:900;text-align:center;">🎶 Canciones Populares por Género</h2>
  <div style="display:flex;justify-content:center;margin:18px 0 0 0;">
    <select id="select-genero" style="padding:8px 18px;border-radius:16px;font-size:1.1rem;font-weight:700;color:#5a189a;background:#f3e8ff;border:1.5px solid #ba01ff;min-width:220px;max-width:100%;">
      <option value="" disabled selected>Selecciona un género...</option>
    </select>
  </div>

  <div id="generos-canciones" style="margin:32px auto;max-width:1100px;"></div>
  
  <script>
  function crearEstrellas() {
    return `
      <div class="star-rating" style="display:flex;gap:8px;justify-content:flex-start;align-items:center;margin:12px 0;">
        <span class="star" data-value="1" style="font-size:2rem;cursor:pointer;color:#ddd;transition:color 0.2s;">★</span>
        <span class="star" data-value="2" style="font-size:2rem;cursor:pointer;color:#ddd;transition:color 0.2s;">★</span>
        <span class="star" data-value="3" style="font-size:2rem;cursor:pointer;color:#ddd;transition:color 0.2s;">★</span>
        <span class="star" data-value="4" style="font-size:2rem;cursor:pointer;color:#ddd;transition:color 0.2s;">★</span>
        <span class="star" data-value="5" style="font-size:2rem;cursor:pointer;color:#ddd;transition:color 0.2s;">★</span>
      </div>
      <input type="hidden" id="calificacion" value="0">
    `;
  }

  function activarEstrellas() {
    const stars = document.querySelectorAll('.star');
    const inputCalificacion = document.getElementById('calificacion');
    let selectedRating = 0;

    stars.forEach(star => {
      star.addEventListener('mouseenter', function() {
        const value = parseInt(this.getAttribute('data-value'));
        stars.forEach((s, idx) => {
          if (idx < value) {
            s.style.color = '#ffd700';
          } else {
            s.style.color = selectedRating > idx ? '#ba01ff' : '#ddd';
          }
        });
      });

      star.addEventListener('click', function() {
        selectedRating = parseInt(this.getAttribute('data-value'));
        inputCalificacion.value = selectedRating;
        stars.forEach((s, idx) => {
          s.style.color = idx < selectedRating ? '#ba01ff' : '#ddd';
        });
      });
    });

    document.querySelector('.star-rating').addEventListener('mouseleave', function() {
      stars.forEach((s, idx) => {
        s.style.color = idx < selectedRating ? '#ba01ff' : '#ddd';
      });
    });
  }

  function mainCanciones() {
    const generos = [
      { nombre: "Pop", query: "genre:pop" },
      { nombre: "Rock", query: "genre:rock" },
      { nombre: "Reggaeton", query: "genre:reggaeton" },
      { nombre: "Hip Hop", query: "genre:hip hop" },
      { nombre: "Electrónica", query: "genre:electronic" },
      { nombre: "Indie", query: "genre:indie" },
      { nombre: "Jazz", query: "genre:jazz" },
      { nombre: "Metal", query: "genre:metal" },
      { nombre: "Country", query: "genre:country" },
      { nombre: "Reggae", query: "genre:reggae" },
      { nombre: "Blues", query: "genre:blues" },
      { nombre: "Folk", query: "genre:folk" },
      { nombre: "Clásica", query: "genre:classical" },
      { nombre: "Latina", query: "genre:latin" },
      { nombre: "Dance", query: "genre:dance" },
      { nombre: "Soul", query: "genre:soul" },
      { nombre: "Funk", query: "genre:funk" },
      { nombre: "Trap", query: "genre:trap" },
      { nombre: "R&B", query: "genre:r&b" },
      { nombre: "Alternativa", query: "genre:alternative" },
      { nombre: "Punk", query: "genre:punk" },
      { nombre: "Ska", query: "genre:ska" },
      { nombre: "Disco", query: "genre:disco" },
      { nombre: "K-Pop", query: "genre:k-pop" },
      { nombre: "Cumbia", query: "genre:cumbia" },
      { nombre: "Bachata", query: "genre:bachata" },
      { nombre: "Salsa", query: "genre:salsa" },
      { nombre: "Tango", query: "genre:tango" },
      { nombre: "Flamenco", query: "genre:flamenco" }
    ];

    function renderNavGeneros() {
      const select = document.getElementById('select-genero');
      select.innerHTML = '<option value="" disabled selected>Selecciona un género...</option>' +
        generos.map(g => `<option value="genero-${g.nombre.replace(/[^a-zA-Z0-9]/g,'')}">${g.nombre}</option>`).join("");
      select.addEventListener('change', function() {
        const targetId = this.value;
        const target = document.getElementById(targetId);
        if (target) {
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
    }
    renderNavGeneros();

    async function cargarCancionesPopulares() {
      const cont = document.getElementById("generos-canciones");
      cont.innerHTML = "<div style='text-align:center;color:#5a189a;font-size:1.3rem;'>Cargando canciones populares...</div>";
      let html = "";
      let allTracks = [];

      const peticiones = generos.map(genero =>
        fetch(`https://attomusic.onrender.com/search?q=${encodeURIComponent(genero.query)}&type=track&limit=12`)
          .then(res => res.json())
          .then(data => ({ genero, data }))
      );
      const resultados = await Promise.all(peticiones);

      for (const { genero, data } of resultados) {
        let allTracksGenero = data.tracks?.items || [];
        let maxPop = Math.max(...allTracksGenero.map(t => t.popularity), 0);
        let minPop = maxPop - 10;
        let tracks = allTracksGenero.filter(track => track.popularity >= minPop && track.popularity <= maxPop && maxPop > 0);
        html += `<h3 id='genero-${genero.nombre.replace(/[^a-zA-Z0-9]/g,'')}' style='color:#ba01ff;margin-top:32px;'>${genero.nombre}</h3>`;
        if (tracks.length > 0) {
          html += `<div class='row' style='margin-bottom:24px;gap:24px;display:flex;flex-wrap:wrap;'>`;
            tracks.forEach((track, idx) => {
              const cardId = `track-${genero.nombre.replace(/[^a-zA-Z0-9]/g,'')}-${idx}`;
              html += `
                <div class='search-card vertical-card' id='${cardId}' style='margin-bottom:18px;'>
                  <img src='${track.album?.images?.[0]?.url || ''}' alt='cover'>
                  <div class='card-info'>
                    <h3>${track.name}</h3>
                    <p>👩‍🎤 ${track.artists.map(a => a.name).join(", ")}</p>
                    <p>📅 ${track.album?.release_date || ''}</p>
                    <p>🔥 Popularidad: ${track.popularity}</p>
                  </div>
                </div>
              `;
            allTracks.push({ cardId, track });
          });
          html += `</div>`;
        } else {
          html += `<div style='color:#5a189a;font-size:1.1rem;margin-bottom:32px;text-align:center;'>No hay canciones populares en este género.</div>`;
        }
      }
      cont.innerHTML = html || "<div style='text-align:center;color:#ba01ff;font-size:1.2rem;'>No se encontraron canciones populares.</div>";
      allTracks.forEach(({ cardId, track }) => {
        const card = document.getElementById(cardId);
        if (card) {
          card.addEventListener('click', () => window.mostrarDetalleCancion(track.id));
        }
      });
    }

    window.mostrarDetalleCancion = async function(id) {
      const cont = document.getElementById("generos-canciones");
      
      cont.innerHTML = `<div style='width:100%;padding:24px 0;'><div id='detalle-cancion'></div></div>`;
      const detalle = document.getElementById('detalle-cancion');
      detalle.innerHTML = `<div style='text-align:center;color:#5a189a;font-size:1.5rem;'>Cargando...</div>`;
      
      const res = await fetch(`https://attomusic.onrender.com/track/${id}`);
      const track = await res.json();
      let img = track.album?.images?.[0]?.url || "";
      
      detalle.innerHTML = `
        <button id='volver-btn' class='btn' style='margin-bottom:24px;background:linear-gradient(160deg,#ba01ff,#00dffc);color:white;border:none;font-weight:700;padding:10px 24px;border-radius:12px;'>⟵ Volver</button>
        
        <div id='detalle-container' style='display:grid;grid-template-columns:300px 1fr;gap:32px;align-items:start;background:linear-gradient(135deg,#f3e8ff 0%,#e0f7ff 100%);padding:32px;border-radius:18px;box-shadow:0 4px 20px rgba(90,24,154,0.15);'>
          
          <div style='display:flex;flex-direction:column;align-items:center;'>
            ${img ? `<img src='${img}' alt='cover' style='width:100%;max-width:280px;height:auto;border-radius:18px;margin-bottom:18px;box-shadow:0 8px 24px rgba(90,24,154,0.2);'>` : ""}
          </div>
          
          <div style='display:flex;flex-direction:column;gap:16px;'>
            <h1 class='detalle-title' style='color:#5a189a;font-size:2.5rem;font-weight:900;margin:0;'>${track.name}</h1>
            
            <div style='display:flex;flex-wrap:wrap;gap:24px;'>
              <p class='detalle-text' style='color:#ba01ff;font-weight:700;font-size:1.2rem;margin:0;'>👩‍🎤 ${track.artists.map(a => a.name).join(", ")}</p>
              <p class='detalle-text' style='color:#5a189a;font-size:1.1rem;margin:0;'>💿 ${track.album?.name || ""}</p>
            </div>
            
            <div style='display:flex;flex-wrap:wrap;gap:24px;'>
              <p class='detalle-text' style='color:#5a189a;font-size:1.1rem;margin:0;'>📅 ${track.album?.release_date || ""}</p>
              <p class='detalle-text' style='color:#ff9100;font-size:1.1rem;margin:0;'>🔥 Popularidad: ${track.popularity}</p>
            </div>
            
            <div class='detalle-section' style='margin-top:24px;padding:24px;background:white;border-radius:12px;box-shadow:0 2px 12px rgba(90,24,154,0.08);'>
              <h4 style='color:#ba01ff;margin-bottom:16px;font-size:1.3rem;'>Califica esta canción</h4>
              <form id='calificar-form'>
                ${crearEstrellas()}
                <button type='submit' class='btn' style='margin-top:10px;background:linear-gradient(160deg,#ba01ff,#00dffc);border:none;color:white;padding:8px 24px;border-radius:8px;font-weight:600;'>Enviar calificación</button>
              </form>
              <div id='calificacion-result' style='margin-top:12px;'></div>
            </div>
            
            <div class='detalle-section' style='margin-top:16px;padding:24px;background:white;border-radius:12px;box-shadow:0 2px 12px rgba(90,24,154,0.08);'>
              <h4 style='color:#5a189a;margin-bottom:16px;font-size:1.3rem;'>Deja un comentario</h4>
              <form id='comentario-form'>
                <textarea id='comentario' rows='3' required class='detalle-textarea' style='width:100%;border-radius:8px;border:1px solid #5a189a;padding:12px;font-size:1rem;'></textarea>
                <button type='submit' class='btn' style='margin-top:10px;background:linear-gradient(160deg,#5a189a,#00dffc);border:none;width:100%;color:white;padding:10px;border-radius:8px;font-weight:600;'>Enviar comentario</button>
              </form>
              <div id='comentario-result' style='margin-top:12px;'></div>
            </div>
            
          </div>
        </div>
        
        <style>
          /* Modo oscuro para detalle de canción */
          [data-bs-theme="dark"] #detalle-container {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%) !important;
          }
          
          [data-bs-theme="dark"] .detalle-title {
            color: #b983ff !important;
          }
          
          [data-bs-theme="dark"] .detalle-text {
            color: #e0e0e0 !important;
          }
          
          [data-bs-theme="dark"] .detalle-section {
            background: #23272f !important;
          }
          
          [data-bs-theme="dark"] .detalle-section h4 {
            color: #b983ff !important;
          }
          
          [data-bs-theme="dark"] .detalle-textarea {
            background: #1a1a2e !important;
            color: #e0e0e0 !important;
            border-color: #b983ff !important;
          }
          
          @media (max-width: 768px) {
            #detalle-cancion > button + div {
              grid-template-columns: 1fr !important;
              text-align: center;
            }
            #detalle-cancion .star-rating {
              justify-content: center !important;
            }
          }
        </style>
      `;
      
      activarEstrellas();
      
      document.getElementById('volver-btn').onclick = () => {
        cargarCancionesPopulares();
      };
      
      document.getElementById("calificar-form").addEventListener("submit", function(e) {
        e.preventDefault();
        const val = document.getElementById("calificacion").value;
        if (val > 0) {
          document.getElementById("calificacion-result").innerHTML = `<p style='color:#5a189a;'>¡Gracias! Calificaste esta canción con <b>${val}</b> estrellas.</p>`;
        } else {
          document.getElementById("calificacion-result").innerHTML = `<p style='color:#ff0000;'>Por favor selecciona una calificación</p>`;
        }
      });
      
      document.getElementById("comentario-form").addEventListener("submit", function(e) {
        e.preventDefault();
        const comentario = document.getElementById("comentario").value.trim();
        if (comentario) {
          document.getElementById("comentario-result").innerHTML = `<p style='color:#5a189a;'>¡Gracias por tu comentario!</p><div style='background:#f3e8ff;border-radius:8px;padding:10px;margin-top:6px;color:#5a189a;'>${comentario}</div>`;
          document.getElementById("comentario").value = "";
        }
      });
    }

    cargarCancionesPopulares();
  }
  mainCanciones();
  </script>
</body>
</html>