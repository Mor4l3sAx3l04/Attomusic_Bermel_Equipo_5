<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AttoMusic - Canciones por GÃ©nero</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <link rel="shortcut icon" href="images/icono.png" type="image/x-icon">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap" rel="stylesheet">
</head>
<body>

<div id="nav-generos" style="max-width:1100px;margin:32px auto 0 auto;">
  <h2 style="color:#5a189a;font-weight:900;text-align:center;">ðŸŽ¶ Canciones Populares por GÃ©nero</h2>
  <div style="display:flex;justify-content:center;margin:18px 0 0 0;">
    <select id="select-genero" style="padding:8px 18px;border-radius:16px;font-size:1.1rem;font-weight:700;color:#5a189a;background:#f3e8ff;border:1.5px solid #ba01ff;min-width:220px;max-width:100%;">
      <option value="" disabled selected>Selecciona un gÃ©nero...</option>
    </select>
  </div>

  <div id="generos-canciones" style="margin:32px auto;max-width:1100px;"></div>
  
  <script>
  function crearEstrellas() {
    return `
      <div class="star-rating" style="display:flex;gap:8px;justify-content:flex-start;align-items:center;margin:12px 0;">
        <span class="star" data-value="1" style="font-size:2rem;cursor:pointer;color:#ddd;transition:color 0.2s;">â˜…</span>
        <span class="star" data-value="2" style="font-size:2rem;cursor:pointer;color:#ddd;transition:color 0.2s;">â˜…</span>
        <span class="star" data-value="3" style="font-size:2rem;cursor:pointer;color:#ddd;transition:color 0.2s;">â˜…</span>
        <span class="star" data-value="4" style="font-size:2rem;cursor:pointer;color:#ddd;transition:color 0.2s;">â˜…</span>
        <span class="star" data-value="5" style="font-size:2rem;cursor:pointer;color:#ddd;transition:color 0.2s;">â˜…</span>
      </div>
      <input type="hidden" id="calificacion" value="0">
    `;
  }

  function activarEstrellas() {
    const stars = document.querySelectorAll('.star');
    const inputCalificacion = document.getElementById('calificacion');
    let selectedRating = 0;

    stars.forEach(star => {
      star.addEventListener('mouseenter', function() {
        const value = parseInt(this.getAttribute('data-value'));
        stars.forEach((s, idx) => {
          if (idx < value) {
            s.style.color = '#ffd700';
          } else {
            s.style.color = selectedRating > idx ? '#ba01ff' : '#ddd';
          }
        });
      });

      star.addEventListener('click', function() {
        selectedRating = parseInt(this.getAttribute('data-value'));
        inputCalificacion.value = selectedRating;
        stars.forEach((s, idx) => {
          s.style.color = idx < selectedRating ? '#ba01ff' : '#ddd';
        });
      });
    });

    document.querySelector('.star-rating').addEventListener('mouseleave', function() {
      stars.forEach((s, idx) => {
        s.style.color = idx < selectedRating ? '#ba01ff' : '#ddd';
      });
    });
  }

  function mainCanciones() {
    // âœ… SISTEMA DE CACHÃ‰ (almacena resultados en memoria)
    const CACHE_KEY = 'attomusic_canciones_cache';
    const CACHE_DURATION = 30 * 60 * 1000; // 30 minutos
    
    // Intentar cargar desde cachÃ©
    function cargarDesdeCache() {
      try {
        const cached = localStorage.getItem(CACHE_KEY);
        if (!cached) return null;
        
        const data = JSON.parse(cached);
        const ahora = Date.now();
        
        // Verificar si el cachÃ© expirÃ³
        if (ahora - data.timestamp > CACHE_DURATION) {
          localStorage.removeItem(CACHE_KEY);
          return null;
        }
        
        console.log('ðŸ“¦ Cargando desde cachÃ© (no hace peticiones)');
        return data.canciones;
      } catch (err) {
        console.error('Error leyendo cachÃ©:', err);
        return null;
      }
    }
    
    // Guardar en cachÃ©
    function guardarEnCache(canciones) {
      try {
        const data = {
          timestamp: Date.now(),
          canciones: canciones
        };
        localStorage.setItem(CACHE_KEY, JSON.stringify(data));
        console.log('ðŸ’¾ Canciones guardadas en cachÃ©');
      } catch (err) {
        console.error('Error guardando cachÃ©:', err);
      }
    }
    
    // âœ… GÃ‰NEROS OPTIMIZADOS
    const generos = [
      { nombre: "ðŸŽ¤ Pop", query: "pop", limit: 12 },
      { nombre: "ðŸŽ¸ Rock", query: "rock", limit: 12 },
      { nombre: "ðŸ”¥ ReggaetÃ³n", query: "Bad Bunny", limit: 12 },
      { nombre: "ðŸŽ¤ Hip Hop", query: "Eminem", limit: 12 },
      { nombre: "ðŸŽ¹ ElectrÃ³nica", query: "electronic", limit: 12 },
      { nombre: "ðŸŒŸ Indie", query: "indie", limit: 12 },
      { nombre: "ðŸŽ· Jazz", query: "jazz", limit: 12 },
      { nombre: "ðŸ¤˜ Metal", query: "Metallica", limit: 12 },
      { nombre: "ðŸ¤  Country", query: "country", limit: 12 },
      { nombre: "ðŸŒ´ Reggae", query: "reggae", limit: 12 },
      { nombre: "ðŸŽº Blues", query: "blues", limit: 12 },
      { nombre: "ðŸª• Folk", query: "folk", limit: 12 },
      { nombre: "ðŸŽ» ClÃ¡sica", query: "classical", limit: 12 },
      { nombre: "ðŸŽº Latina", query: "latin", limit: 12 },
      { nombre: "ðŸ’ƒ Dance", query: "dance", limit: 12 },
      { nombre: "ðŸ’™ Soul", query: "soul", limit: 12 },
      { nombre: "ðŸŽµ Funk", query: "funk", limit: 12 },
      { nombre: "ðŸ”Š Trap", query: "Travis Scott", limit: 12 },
      { nombre: "ðŸ’œ R&B", query: "rnb", limit: 12 },
      { nombre: "ðŸŽ§ Alternativa", query: "alternative", limit: 12 },
      { nombre: "ðŸ’¥ Punk", query: "punk", limit: 12 },
      { nombre: "ðŸŽº Ska", query: "ska", limit: 12 },
      { nombre: "âœ¨ Disco", query: "disco", limit: 12 },
      { nombre: "ðŸ‡°ðŸ‡· K-Pop", query: "BTS", limit: 12 },
      { nombre: "ðŸŽº Cumbia", query: "cumbia", limit: 12 },
      { nombre: "ðŸ’ƒ Bachata", query: "Romeo Santos", limit: 12 },
      { nombre: "ðŸŽº Salsa", query: "salsa", limit: 12 },
      { nombre: "ðŸŽ» Tango", query: "tango", limit: 12 },
      { nombre: "ðŸŽ¸ Flamenco", query: "flamenco", limit: 12 },
      { nombre: "ðŸŽ¹ House", query: "house", limit: 12 }
    ];

    function renderNavGeneros() {
      const select = document.getElementById('select-genero');
      select.innerHTML = '<option value="" disabled selected>Selecciona un gÃ©nero...</option>' +
        generos.map(g => `<option value="genero-${g.nombre.replace(/[^a-zA-Z0-9]/g,'')}">${g.nombre}</option>`).join("");
      select.addEventListener('change', function() {
        const targetId = this.value;
        const target = document.getElementById(targetId);
        if (target) {
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
    }
    renderNavGeneros();

    // âœ… OPTIMIZACIÃ“N: Cargar gÃ©neros en PARALELO y mostrar progresivamente
    async function cargarCancionesPopulares() {
      const cont = document.getElementById("generos-canciones");
      
      // 1ï¸âƒ£ INTENTAR CARGAR DESDE CACHÃ‰ PRIMERO
      const cancionesCache = cargarDesdeCache();
      
      if (cancionesCache) {
        // Renderizar inmediatamente desde cachÃ©
        renderizarCancionesDesdeCache(cancionesCache);
        return;
      }
      
      // 2ï¸âƒ£ Si no hay cachÃ©, hacer peticiones
      console.log('ðŸŒ No hay cachÃ©, haciendo peticiones a Spotify...');
      
      // Crear contenedores para cada gÃ©nero ANTES de cargar
      let html = "";
      generos.forEach(genero => {
        const generoId = genero.nombre.replace(/[^a-zA-Z0-9]/g,'');
        html += `
          <h3 id='genero-${generoId}' style='color:#ba01ff;margin-top:32px;'>${genero.nombre}</h3>
          <div id='container-${generoId}' class='genero-container' style='margin-bottom:24px;'>
            <div style='text-align:center;color:#999;padding:20px;'>
              <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
              <span style='margin-left:8px;'>Cargando...</span>
            </div>
          </div>
        `;
      });
      cont.innerHTML = html;

      // âœ… CARGAR TODOS LOS GÃ‰NEROS EN PARALELO
      const promesas = generos.map(genero => cargarGenero(genero));
      const resultados = await Promise.allSettled(promesas);
      
      // 3ï¸âƒ£ GUARDAR RESULTADOS EN CACHÃ‰
      const cancionesParaCache = {};
      resultados.forEach((resultado, index) => {
        if (resultado.status === 'fulfilled' && resultado.value) {
          const generoId = generos[index].nombre.replace(/[^a-zA-Z0-9]/g,'');
          cancionesParaCache[generoId] = resultado.value;
        }
      });
      
      guardarEnCache(cancionesParaCache);
    }
    
    // âœ… Renderizar canciones desde cachÃ©
    function renderizarCancionesDesdeCache(cancionesCache) {
      const cont = document.getElementById("generos-canciones");
      let html = "";
      
      generos.forEach(genero => {
        const generoId = genero.nombre.replace(/[^a-zA-Z0-9]/g,'');
        const tracks = cancionesCache[generoId] || [];
        
        html += `<h3 id='genero-${generoId}' style='color:#ba01ff;margin-top:32px;'>${genero.nombre}</h3>`;
        html += `<div id='container-${generoId}' class='genero-container' style='margin-bottom:24px;'>`;
        
        if (tracks.length > 0) {
          html += `<div class='row' style='gap:24px;display:flex;flex-wrap:wrap;'>`;
          
          tracks.forEach((track, idx) => {
            const cardId = `track-${generoId}-${idx}`;
            html += `
              <div class='search-card vertical-card' id='${cardId}' style='margin-bottom:18px;cursor:pointer;' data-track-id='${track.id}'>
                <img src='${track.album?.images?.[0]?.url || ''}' alt='cover' loading='lazy'>
                <div class='card-info'>
                  <h3>${track.name}</h3>
                  <p>ðŸ‘©â€ðŸŽ¤ ${track.artists.map(a => a.name).join(", ")}</p>
                  <p>ðŸ“… ${track.album?.release_date || ''}</p>
                  <p>ðŸ”¥ Popularidad: ${track.popularity}</p>
                </div>
              </div>
            `;
          });
          
          html += `</div>`;
        } else {
          html += `<div style='color:#999;font-size:1rem;text-align:center;padding:20px;'>No se encontraron canciones para este gÃ©nero.</div>`;
        }
        
        html += `</div>`;
      });
      
      cont.innerHTML = html;
      
      // Agregar event listeners
      generos.forEach(genero => {
        const generoId = genero.nombre.replace(/[^a-zA-Z0-9]/g,'');
        const tracks = cancionesCache[generoId] || [];
        
        tracks.forEach((track, idx) => {
          const card = document.getElementById(`track-${generoId}-${idx}`);
          if (card) {
            card.addEventListener('click', () => window.mostrarDetalleCancion(track.id));
          }
        });
      });
    }

    // âœ… FunciÃ³n para cargar UN gÃ©nero
    async function cargarGenero(genero) {
      const generoId = genero.nombre.replace(/[^a-zA-Z0-9]/g,'');
      const container = document.getElementById(`container-${generoId}`);
      
      if (!container) return null;

      try {
        const res = await fetch(`/spotify/search?q=${encodeURIComponent(genero.query)}&type=track&limit=${genero.limit}`);
        
        if (!res.ok) throw new Error('Error en bÃºsqueda');
        
        const data = await res.json();
        let tracks = data.tracks?.items || [];
        
        // Filtrar y ordenar
        tracks = tracks
          .filter(t => t.popularity > 40)
          .sort((a, b) => b.popularity - a.popularity)
          .slice(0, 12);

        // Renderizar inmediatamente cuando llegue la respuesta
        if (tracks.length > 0) {
          let html = `<div class='row' style='gap:24px;display:flex;flex-wrap:wrap;'>`;
          
          tracks.forEach((track, idx) => {
            const cardId = `track-${generoId}-${idx}`;
            html += `
              <div class='search-card vertical-card' id='${cardId}' style='margin-bottom:18px;cursor:pointer;' data-track-id='${track.id}'>
                <img src='${track.album?.images?.[0]?.url || ''}' alt='cover' loading='lazy'>
                <div class='card-info'>
                  <h3>${track.name}</h3>
                  <p>ðŸ‘©â€ðŸŽ¤ ${track.artists.map(a => a.name).join(", ")}</p>
                  <p>ðŸ“… ${track.album?.release_date || ''}</p>
                  <p>ðŸ”¥ Popularidad: ${track.popularity}</p>
                </div>
              </div>
            `;
          });
          
          html += `</div>`;
          container.innerHTML = html;
          
          // Agregar event listeners
          tracks.forEach((track, idx) => {
            const card = document.getElementById(`track-${generoId}-${idx}`);
            if (card) {
              card.addEventListener('click', () => window.mostrarDetalleCancion(track.id));
            }
          });
        } else {
          container.innerHTML = `<div style='color:#999;font-size:1rem;text-align:center;padding:20px;'>No se encontraron canciones para este gÃ©nero.</div>`;
        }
        
        // âœ… RETORNAR las canciones para guardar en cachÃ©
        return tracks;
        
      } catch (err) {
        console.error(`Error cargando ${genero.nombre}:`, err);
        container.innerHTML = `<div style='color:#ff5555;font-size:1rem;text-align:center;padding:20px;'>Error al cargar canciones</div>`;
        return null;
      }
    }

    window.mostrarDetalleCancion = async function(id) {
      const cont = document.getElementById("generos-canciones");
      
      cont.innerHTML = `<div style='width:100%;padding:24px 0;'><div id='detalle-cancion'></div></div>`;
      const detalle = document.getElementById('detalle-cancion');
      detalle.innerHTML = `<div style='text-align:center;color:#5a189a;font-size:1.5rem;'>Cargando...</div>`;
      
      const res = await fetch(`/spotify/track/${id}`);
      const track = await res.json();
      let img = track.album?.images?.[0]?.url || "";
      
      detalle.innerHTML = `
        <button id='volver-btn' class='btn' style='margin-bottom:24px;background:linear-gradient(160deg,#ba01ff,#00dffc);color:white;border:none;font-weight:700;padding:10px 24px;border-radius:12px;'>âŸµ Volver</button>
        
        <div id='detalle-container' style='display:grid;grid-template-columns:300px 1fr;gap:32px;align-items:start;background:linear-gradient(135deg,#f3e8ff 0%,#e0f7ff 100%);padding:32px;border-radius:18px;box-shadow:0 4px 20px rgba(90,24,154,0.15);'>
          
          <div style='display:flex;flex-direction:column;align-items:center;'>
            ${img ? `<img src='${img}' alt='cover' style='width:100%;max-width:280px;height:auto;border-radius:18px;margin-bottom:18px;box-shadow:0 8px 24px rgba(90,24,154,0.2);'>` : ""}
          </div>
          
          <div style='display:flex;flex-direction:column;gap:16px;'>
            <h1 class='detalle-title' style='color:#5a189a;font-size:2.5rem;font-weight:900;margin:0;'>${track.name}</h1>
            
            <div style='display:flex;flex-wrap:wrap;gap:24px;'>
              <p class='detalle-text' style='color:#ba01ff;font-weight:700;font-size:1.2rem;margin:0;'>ðŸ‘©â€ðŸŽ¤ ${track.artists.map(a => a.name).join(", ")}</p>
              <p class='detalle-text' style='color:#5a189a;font-size:1.1rem;margin:0;'>ðŸ’¿ ${track.album?.name || ""}</p>
            </div>
            
            <div style='display:flex;flex-wrap:wrap;gap:24px;'>
              <p class='detalle-text' style='color:#5a189a;font-size:1.1rem;margin:0;'>ðŸ“… ${track.album?.release_date || ""}</p>
              <p class='detalle-text' style='color:#ff9100;font-size:1.1rem;margin:0;'>ðŸ”¥ Popularidad: ${track.popularity}</p>
            </div>
            
            <div class='detalle-section' style='margin-top:24px;padding:24px;background:white;border-radius:12px;box-shadow:0 2px 12px rgba(90,24,154,0.08);'>
              <h4 style='color:#ba01ff;margin-bottom:16px;font-size:1.3rem;'>Califica esta canciÃ³n</h4>
              <form id='calificar-form'>
                ${crearEstrellas()}
                <button type='submit' class='btn' style='margin-top:10px;background:linear-gradient(160deg,#ba01ff,#00dffc);border:none;color:white;padding:8px 24px;border-radius:8px;font-weight:600;'>Enviar calificaciÃ³n</button>
              </form>
              <div id='calificacion-result' style='margin-top:12px;'></div>
            </div>
            
            <div class='detalle-section' style='margin-top:16px;padding:24px;background:white;border-radius:12px;box-shadow:0 2px 12px rgba(90,24,154,0.08);'>
              <h4 style='color:#5a189a;margin-bottom:16px;font-size:1.3rem;'>Deja un comentario</h4>
              <form id='comentario-form'>
                <textarea id='comentario' rows='3' required class='detalle-textarea' style='width:100%;border-radius:8px;border:1px solid #5a189a;padding:12px;font-size:1rem;'></textarea>
                <button type='submit' class='btn' style='margin-top:10px;background:linear-gradient(160deg,#5a189a,#00dffc);border:none;width:100%;color:white;padding:10px;border-radius:8px;font-weight:600;'>Enviar comentario</button>
              </form>
              <div id='comentario-result' style='margin-top:12px;'></div>
            </div>
            
          </div>
        </div>
        
        <style>
          [data-bs-theme="dark"] #detalle-container {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%) !important;
          }
          
          [data-bs-theme="dark"] .detalle-title {
            color: #b983ff !important;
          }
          
          [data-bs-theme="dark"] .detalle-text {
            color: #e0e0e0 !important;
          }
          
          [data-bs-theme="dark"] .detalle-section {
            background: #23272f !important;
          }
          
          [data-bs-theme="dark"] .detalle-section h4 {
            color: #b983ff !important;
          }
          
          [data-bs-theme="dark"] .detalle-textarea {
            background: #1a1a2e !important;
            color: #e0e0e0 !important;
            border-color: #b983ff !important;
          }
          
          @media (max-width: 768px) {
            #detalle-cancion > button + div {
              grid-template-columns: 1fr !important;
              text-align: center;
            }
            #detalle-cancion .star-rating {
              justify-content: center !important;
            }
          }
        </style>
      `;
      
      activarEstrellas();
      
      document.getElementById('volver-btn').onclick = () => {
        cargarCancionesPopulares();
      };
      
      document.getElementById("calificar-form").addEventListener("submit", function(e) {
        e.preventDefault();
        const val = document.getElementById("calificacion").value;
        if (val > 0) {
          document.getElementById("calificacion-result").innerHTML = `<p style='color:#5a189a;'>Â¡Gracias! Calificaste esta canciÃ³n con <b>${val}</b> estrellas.</p>`;
        } else {
          document.getElementById("calificacion-result").innerHTML = `<p style='color:#ff0000;'>Por favor selecciona una calificaciÃ³n</p>`;
        }
      });
      
      document.getElementById("comentario-form").addEventListener("submit", function(e) {
        e.preventDefault();
        const comentario = document.getElementById("comentario").value.trim();
        if (comentario) {
          document.getElementById("comentario-result").innerHTML = `<p style='color:#5a189a;'>Â¡Gracias por tu comentario!</p><div style='background:#f3e8ff;border-radius:8px;padding:10px;margin-top:6px;color:#5a189a;'>${comentario}</div>`;
          document.getElementById("comentario").value = "";
        }
      });
    }

    cargarCancionesPopulares();
  }
  mainCanciones();
  </script>
</body>
</html>