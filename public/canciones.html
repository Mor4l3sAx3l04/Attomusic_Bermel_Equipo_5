<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AttoMusic - Canciones por GÃ©nero</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  <link rel="shortcut icon" href="images/icono.png" type="image/x-icon">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap" rel="stylesheet">
</head>
<body>

<div id="nav-generos" style="max-width:1100px;margin:32px auto 0 auto;">
  <h2 style="color:#5a189a;font-weight:900;text-align:center;">ðŸŽ¶ Canciones Populares por GÃ©nero</h2>
  <div style="display:flex;justify-content:center;margin:18px 0 0 0;">
    <select id="select-genero" style="padding:8px 18px;border-radius:16px;font-size:1.1rem;font-weight:700;color:#5a189a;background:#f3e8ff;border:1.5px solid #ba01ff;min-width:220px;max-width:100%;">
      <option value="" disabled selected>Selecciona un gÃ©nero...</option>
    </select>
  </div>

  <div id="generos-canciones" style="margin:32px auto;max-width:1100px;"></div>
  
  <!-- âœ… IMPORTAR EL MÃ“DULO REUTILIZABLE -->
  <script src="js/detalleCancion.js"></script>
  
  <script>
  function mainCanciones() {
    // Inicializar mÃ³dulo con email del usuario
    const userEmail = sessionStorage.getItem('userEmail') || sessionStorage.getItem('correo');
    DetalleCancion.init(userEmail);

    // SISTEMA DE CACHÃ‰
    const CACHE_KEY = 'attomusic_canciones_cache';
    const CACHE_DURATION = 15 * 60 * 1000; // 15 minutos
    
    function cargarDesdeCache() {
      try {
        const cached = localStorage.getItem(CACHE_KEY);
        if (!cached) return null;
        
        const data = JSON.parse(cached);
        const ahora = Date.now();
        
        if (ahora - data.timestamp > CACHE_DURATION) {
          localStorage.removeItem(CACHE_KEY);
          return null;
        }
        
        //console.log('ðŸ“¦ Cargando desde cachÃ©');
        return data.canciones;
      } catch (err) {
        console.error('Error leyendo cachÃ©:', err);
        return null;
      }
    }
    
    function guardarEnCache(canciones) {
      try {
        const data = {
          timestamp: Date.now(),
          canciones: canciones
        };
        localStorage.setItem(CACHE_KEY, JSON.stringify(data));
        //console.log('ðŸ’¾ Canciones guardadas en cachÃ©');
      } catch (err) {
        console.error('Error guardando cachÃ©:', err);
      }
    }
    
    const generos = [
      { nombre: "ðŸŽ¤ Pop", query: "pop", limit: 12 },
      { nombre: "ðŸŽ¸ Rock", query: "rock", limit: 12 },
      { nombre: "ðŸ”¥ ReggaetÃ³n", query: "Bad Bunny", limit: 12 },
      { nombre: "ðŸŽ¤ Hip Hop", query: "Eminem", limit: 12 },
      { nombre: "ðŸŽ¹ ElectrÃ³nica", query: "electronic", limit: 12 },
      { nombre: "ðŸŒŸ Indie", query: "indie", limit: 12 },
      { nombre: "ðŸŽ· Jazz", query: "jazz", limit: 12 },
      { nombre: "ðŸ¤˜ Metal", query: "Metallica", limit: 12 },
      { nombre: "ðŸ¤  Country", query: "country", limit: 12 },
      { nombre: "ðŸŒ´ Reggae", query: "reggae", limit: 12 },
      { nombre: "ðŸŽº Blues", query: "blues", limit: 12 },
      { nombre: "ðŸª• Folk", query: "folk", limit: 12 },
      { nombre: "ðŸŽ» ClÃ¡sica", query: "classical", limit: 12 },
      { nombre: "ðŸŽº Latina", query: "latin", limit: 12 },
      { nombre: "ðŸ’ƒ Dance", query: "dance", limit: 12 },
      { nombre: "ðŸ’™ Soul", query: "soul", limit: 12 },
      { nombre: "ðŸŽµ Funk", query: "funk", limit: 12 },
      { nombre: "ðŸ”Š Trap", query: "Travis Scott", limit: 12 },
      { nombre: "ðŸ’œ R&B", query: "rnb", limit: 12 },
      { nombre: "ðŸŽ§ Alternativa", query: "alternative", limit: 12 },
      { nombre: "ðŸ’¥ Punk", query: "punk", limit: 12 },
      { nombre: "ðŸŽº Ska", query: "ska", limit: 12 },
      { nombre: "âœ¨ Disco", query: "disco", limit: 12 },
      { nombre: "ðŸ‡°ðŸ‡· K-Pop", query: "BTS", limit: 12 },
      { nombre: "ðŸŽº Cumbia", query: "cumbia", limit: 12 },
      { nombre: "ðŸ’ƒ Bachata", query: "Romeo Santos", limit: 12 },
      { nombre: "ðŸŽº Salsa", query: "salsa", limit: 12 },
      { nombre: "ðŸŽ» Tango", query: "tango", limit: 12 },
      { nombre: "ðŸŽ¸ Flamenco", query: "flamenco", limit: 12 },
      { nombre: "ðŸŽ¹ House", query: "house", limit: 12 }
    ];

    function renderNavGeneros() {
      const select = document.getElementById('select-genero');
      select.innerHTML = '<option value="" disabled selected>Selecciona un gÃ©nero...</option>' +
        generos.map(g => `<option value="genero-${g.nombre.replace(/[^a-zA-Z0-9]/g,'')}">${g.nombre}</option>`).join("");
      select.addEventListener('change', function() {
        const targetId = this.value;
        const target = document.getElementById(targetId);
        if (target) {
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
    }
    renderNavGeneros();

    async function cargarCancionesPopulares() {
      const cont = document.getElementById("generos-canciones");
      
      const cancionesCache = cargarDesdeCache();
      
      if (cancionesCache) {
        renderizarCancionesDesdeCache(cancionesCache);
        return;
      }
      
      //console.log('ðŸŒ No hay cachÃ©, haciendo peticiones a Spotify...');
      
      let html = "";
      generos.forEach(genero => {
        const generoId = genero.nombre.replace(/[^a-zA-Z0-9]/g,'');
        html += `
          <h3 id='genero-${generoId}' style='color:#ba01ff;margin-top:32px;'>${genero.nombre}</h3>
          <div id='container-${generoId}' class='genero-container' style='margin-bottom:24px;'>
            <div style='text-align:center;color:#999;padding:20px;'>
              <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
              <span style='margin-left:8px;'>Cargando...</span>
            </div>
          </div>
        `;
      });
      cont.innerHTML = html;

      const promesas = generos.map(genero => cargarGenero(genero));
      const resultados = await Promise.allSettled(promesas);
      
      const cancionesParaCache = {};
      resultados.forEach((resultado, index) => {
        if (resultado.status === 'fulfilled' && resultado.value) {
          const generoId = generos[index].nombre.replace(/[^a-zA-Z0-9]/g,'');
          cancionesParaCache[generoId] = resultado.value;
        }
      });
      
      guardarEnCache(cancionesParaCache);
    }
    
    function renderizarCancionesDesdeCache(cancionesCache) {
      const cont = document.getElementById("generos-canciones");
      let html = "";
      
      generos.forEach(genero => {
        const generoId = genero.nombre.replace(/[^a-zA-Z0-9]/g,'');
        const tracks = cancionesCache[generoId] || [];
        
        html += `<h3 id='genero-${generoId}' style='color:#ba01ff;margin-top:32px;'>${genero.nombre}</h3>`;
        html += `<div id='container-${generoId}' class='genero-container' style='margin-bottom:24px;'>`;
        
        if (tracks.length > 0) {
          html += `<div class='row' style='gap:24px;display:flex;flex-wrap:wrap;'>`;
          
          tracks.forEach((track, idx) => {
            const cardId = `track-${generoId}-${idx}`;
            html += `
              <div class='search-card vertical-card' id='${cardId}' style='margin-bottom:18px;cursor:pointer;' data-track-id='${track.id}'>
                <img src='${track.album?.images?.[0]?.url || ''}' alt='cover' loading='lazy'>
                <div class='card-info'>
                  <h3>${track.name}</h3>
                  <p>ðŸ‘©â€ðŸŽ¤ ${track.artists.map(a => a.name).join(", ")}</p>
                  <p>ðŸ“… ${track.album?.release_date || ''}</p>
                  <p>ðŸ”¥ Popularidad: ${track.popularity}</p>
                </div>
              </div>
            `;
          });
          
          html += `</div>`;
        } else {
          html += `<div style='color:#999;font-size:1rem;text-align:center;padding:20px;'>No se encontraron canciones para este gÃ©nero.</div>`;
        }
        
        html += `</div>`;
      });
      
      cont.innerHTML = html;
      
      // âœ… Usar el mÃ³dulo reutilizable para los clicks
      generos.forEach(genero => {
        const generoId = genero.nombre.replace(/[^a-zA-Z0-9]/g,'');
        const tracks = cancionesCache[generoId] || [];
        
        tracks.forEach((track, idx) => {
          const card = document.getElementById(`track-${generoId}-${idx}`);
          if (card) {
            card.addEventListener('click', () => {
              // âœ… LLAMAR AL MÃ“DULO REUTILIZABLE
              DetalleCancion.mostrar(track.id, 'generos-canciones', () => {
                cargarCancionesPopulares();
              });
            });
          }
        });
      });
    }

    async function cargarGenero(genero) {
      const generoId = genero.nombre.replace(/[^a-zA-Z0-9]/g,'');
      const container = document.getElementById(`container-${generoId}`);
      
      if (!container) return null;

      try {
        const res = await fetch(`/spotify/search?q=${encodeURIComponent(genero.query)}&type=track&limit=${genero.limit}`);
        
        if (!res.ok) throw new Error('Error en bÃºsqueda');
        
        const data = await res.json();
        let tracks = data.tracks?.items || [];
        
        tracks = tracks
          .filter(t => t.popularity > 40)
          .sort((a, b) => b.popularity - a.popularity)
          .slice(0, 12);

        if (tracks.length > 0) {
          let html = `<div class='row' style='gap:24px;display:flex;flex-wrap:wrap;'>`;
          
          tracks.forEach((track, idx) => {
            const cardId = `track-${generoId}-${idx}`;
            html += `
              <div class='search-card vertical-card' id='${cardId}' style='margin-bottom:18px;cursor:pointer;' data-track-id='${track.id}'>
                <img src='${track.album?.images?.[0]?.url || ''}' alt='cover' loading='lazy'>
                <div class='card-info'>
                  <h3>${track.name}</h3>
                  <p>ðŸ‘©â€ðŸŽ¤ ${track.artists.map(a => a.name).join(", ")}</p>
                  <p>ðŸ“… ${track.album?.release_date || ''}</p>
                  <p>ðŸ”¥ Popularidad: ${track.popularity}</p>
                </div>
              </div>
            `;
          });
          
          html += `</div>`;
          container.innerHTML = html;
          
          // âœ… Usar el mÃ³dulo reutilizable
          tracks.forEach((track, idx) => {
            const card = document.getElementById(`track-${generoId}-${idx}`);
            if (card) {
              card.addEventListener('click', () => {
                DetalleCancion.mostrar(track.id, 'generos-canciones', () => {
                  cargarCancionesPopulares();
                });
              });
            }
          });
        } else {
          container.innerHTML = `<div style='color:#999;font-size:1rem;text-align:center;padding:20px;'>No se encontraron canciones para este gÃ©nero.</div>`;
        }
        
        return tracks;
        
      } catch (err) {
        console.error(`Error cargando ${genero.nombre}:`, err);
        container.innerHTML = `<div style='color:#ff5555;font-size:1rem;text-align:center;padding:20px;'>Error al cargar canciones</div>`;
        return null;
      }
    }

    cargarCancionesPopulares();
  }
  mainCanciones();
  </script>
</body>
</html>