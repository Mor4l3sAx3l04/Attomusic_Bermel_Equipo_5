<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Para Ti - Recomendaciones</title>
</head>
<body>

<div style="max-width:900px;margin:32px auto;padding:0 20px;">
  <div class="news-header mb-5 fade-up-section text-center">
    <h1 id="titulo-siguiendo" style="font-size: 70px;"></h1>
    <p class="text-muted">Basado en tus gustos musicales.</p>
  </div>

  <ul class="nav nav-tabs mb-4" role="tablist">
    <li class="nav-item">
      <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-publicaciones">
        Publicaciones
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-usuarios">
        Usuarios Similares
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-analisis">
        Tu An√°lisis
      </button>
    </li>
  </ul>

  <div class="tab-content">
    <div class="tab-pane fade show active" id="tab-publicaciones">
      <div id="recomendaciones-feed"></div>
    </div>
    <div class="tab-pane fade" id="tab-usuarios">
      <div id="usuarios-similares"></div>
    </div>
    <div class="tab-pane fade" id="tab-analisis">
      <div id="analisis-gustos"></div>
    </div>
  </div>
</div>
<script>animarTituloGlobal('#titulo-siguiendo', 'Para Ti');</script>
<script>
(function() {
  'use strict';

  const usuarioActual = window.getUsuarioActual ? window.getUsuarioActual() : null;

  if (!usuarioActual) {
    document.querySelector('[style*="max-width:900px"]').innerHTML = `
      <div style="text-align:center;padding:60px 20px;">
        <h3 style="color:#5a189a;">Inicia sesi√≥n para ver recomendaciones personalizadas</h3>
        <p style="color:#777;">Descubre m√∫sica y personas con gustos similares a los tuyos</p>
      </div>
    `;
    return;
  }

  // ===== CARGAR PUBLICACIONES RECOMENDADAS =====
  async function cargarRecomendaciones() {
    const feed = document.getElementById('recomendaciones-feed');
    feed.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary"></div><p class="mt-2">Analizando tus gustos...</p></div>';

    try {
      const res = await fetch(`/api/recomendaciones?correo=${encodeURIComponent(usuarioActual.correo)}&limit=20`);
      const data = await res.json();

      if (!res.ok) throw new Error('Error cargando recomendaciones');

      feed.innerHTML = '';

      if (data.recommendations.length === 0) {
        feed.innerHTML = `
          <div class="text-center p-5">
            <p style="color:#777;">
              Interact√∫a con publicaciones para recibir recomendaciones personalizadas üéµ
            </p>
          </div>
        `;
        return;
      }

      // Mostrar artistas principales
      if (data.topArtists && data.topArtists.length > 0) {
        feed.innerHTML += `
          <div style="background:#f3e8ff;padding:16px;border-radius:12px;margin-bottom:24px;">
            <strong style="color:#5a189a;">üé§ Basado en tus artistas favoritos:</strong>
            <div style="margin-top:8px;color:#777;">
              ${data.topArtists.join(", ")}
            </div>
          </div>
        `;
      }

      // Renderizar publicaciones
      data.recommendations.forEach(pub => {
        const article = window.crearPublicacionHTML 
          ? window.crearPublicacionHTML(pub, false)
          : crearPublicacionSimple(pub);
        feed.appendChild(article);
      });

    } catch (err) {
      console.error('Error:', err);
      feed.innerHTML = '<div class="alert alert-danger">Error al cargar recomendaciones</div>';
    }
  }

  // ===== CARGAR USUARIOS SIMILARES =====
  async function cargarUsuariosSimilares() {
    const container = document.getElementById('usuarios-similares');
    container.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary"></div></div>';

    try {
      const res = await fetch(`/api/recomendaciones/usuarios?correo=${encodeURIComponent(usuarioActual.correo)}&limit=15`);
      const data = await res.json();

      if (!res.ok) throw new Error('Error cargando usuarios');

      container.innerHTML = '';

      if (data.recommendations.length === 0) {
        container.innerHTML = '<div class="text-center p-5"><p style="color:#777;">No hay usuarios similares a√∫n</p></div>';
        return;
      }

      // Mostrar info del algoritmo
      if (data.topArtists && data.topArtists.length > 0) {
        container.innerHTML += `
          <div style="background:#f3e8ff;padding:16px;border-radius:12px;margin-bottom:24px;">
            <strong style="color:#5a189a;">üéµ Usuarios que escuchan:</strong>
            <div style="margin-top:8px;color:#777;">
              ${data.topArtists.join(", ")}
            </div>
          </div>
        `;
      }

      // Renderizar usuarios
      data.recommendations.forEach(user => {
        const card = crearTarjetaUsuario(user);
        container.appendChild(card);
      });

    } catch (err) {
      console.error('Error:', err);
      container.innerHTML = '<div class="alert alert-danger">Error al cargar usuarios</div>';
    }
  }

  // ‚úÖ Funci√≥n mejorada para crear tarjetas de usuario
  function crearTarjetaUsuario(user) {
    const div = document.createElement('div');
    div.className = 'perfil-card mb-3 fade-in';
    
    const escapeHtml = window.escapeHtml || ((text) => {
      const divTemp = document.createElement('div');
      divTemp.textContent = text;
      return divTemp.innerHTML;
    });
    
    div.innerHTML = `
      <div class="perfil-card-content">
        <div class="perfil-avatar-container">
          ${user.foto ? 
            `<img src="${user.foto}" alt="${escapeHtml(user.usuario)}" class="perfil-avatar-img">` :
            `<div class="perfil-avatar-placeholder">${user.usuario.charAt(0).toUpperCase()}</div>`
          }
        </div>
        
        <div class="perfil-info">
          <h5 class="perfil-username">@${escapeHtml(user.usuario)}</h5>
          <p class="perfil-stats">
            ${user.artistas_comunes ? `
              <i class="bi bi-music-note-beamed"></i> ${user.artistas_comunes} artistas en com√∫n<br>
            ` : ''}
            <i class="bi bi-people-fill"></i> ${user.seguidores || 0} seguidores
          </p>
        </div>
        
        <div class="perfil-actions">
          <button class="btn-seguir-perfil-similar" data-id-usuario="${user.id_usuario}">
            <i class="bi bi-person-plus"></i>
            <span>Seguir</span>
          </button>
          <button class="btn-ver-perfil load-page-perfil" data-id-usuario="${user.id_usuario}">
            <i class="bi bi-eye"></i> Ver perfil
          </button>
        </div>
      </div>
    `;

    // Event listeners
    const btnSeguir = div.querySelector('.btn-seguir-perfil-similar');
    const btnVerPerfil = div.querySelector('.btn-ver-perfil');
    
    if (btnSeguir) {
      verificarSiguiendoPerfil(user.id_usuario, btnSeguir);
      btnSeguir.addEventListener('click', () => toggleSeguirPerfil(user.id_usuario, btnSeguir));
    }

    if (btnVerPerfil) {
      btnVerPerfil.addEventListener('click', function() {
        const idUsuario = this.getAttribute('data-id-usuario');
        if (typeof loadPage === 'function') {
          loadPage(`perfil-usuario.html?id=${idUsuario}`);
        } else {
          window.location.href = `perfil-usuario.html?id=${idUsuario}`;
        }
      });
    }
    
    return div;
  }

  // ‚úÖ Verificar si ya sigue al usuario
  async function verificarSiguiendoPerfil(idUsuario, btnElement) {
    if (!usuarioActual) return;

    try {
      const res = await fetch(`/api/siguiendo/${idUsuario}?correo=${encodeURIComponent(usuarioActual.correo)}`);
      const data = await res.json();

      if (data.siguiendo) {
        btnElement.classList.add('siguiendo');
        btnElement.querySelector('i').className = 'bi bi-person-check-fill';
        btnElement.querySelector('span').textContent = 'Siguiendo';
      }
    } catch (err) {
      console.error('Error verificando seguimiento:', err);
    }
  }

  // ‚úÖ Toggle seguir/dejar de seguir
  async function toggleSeguirPerfil(idUsuario, btnElement) {
    if (!usuarioActual) {
      if (window.mostrarToast) {
        window.mostrarToast('Debes iniciar sesi√≥n para seguir usuarios', 'error');
      }
      return;
    }

    try {
      const res = await fetch(`/api/seguir/${idUsuario}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ correo: usuarioActual.correo })
      });

      const data = await res.json();

      if (res.ok) {
        if (data.siguiendo) {
          btnElement.classList.add('siguiendo');
          btnElement.querySelector('i').className = 'bi bi-person-check-fill';
          btnElement.querySelector('span').textContent = 'Siguiendo';
        } else {
          btnElement.classList.remove('siguiendo');
          btnElement.querySelector('i').className = 'bi bi-person-plus';
          btnElement.querySelector('span').textContent = 'Seguir';
        }
        if (window.mostrarToast) {
          window.mostrarToast(data.message, 'success');
        }
      }
    } catch (err) {
      console.error('Error al seguir:', err);
      if (window.mostrarToast) {
        window.mostrarToast('Error de conexi√≥n', 'error');
      }
    }
  }

  // ===== CARGAR AN√ÅLISIS DE GUSTOS =====
  async function cargarAnalisis() {
    const container = document.getElementById('analisis-gustos');
    container.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary"></div></div>';

    try {
      const res = await fetch(`/api/recomendaciones/analisis?correo=${encodeURIComponent(usuarioActual.correo)}`);
      const data = await res.json();

      if (!res.ok) throw new Error('Error cargando an√°lisis');

      container.innerHTML = '';

      if (data.totalInteractions === 0) {
        container.innerHTML = `
          <div class="text-center p-5">
            <h4 style="color:#5a189a;">üëã ¬°Bienvenido!</h4>
            <p style="color:#777;">Empieza a interactuar con publicaciones para ver tu an√°lisis musical</p>
          </div>
        `;
        return;
      }

      // Estad√≠sticas generales
      container.innerHTML = `
        <div style="background:#f3e8ff;padding:24px;border-radius:12px;margin-bottom:24px;">
          <h4 style="color:#5a189a;margin-bottom:16px;">üìä Tu Actividad Musical</h4>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:16px;">
            <div style="text-align:center;">
              <div style="font-size:2rem;color:#ba01ff;font-weight:900;">${data.recentActivity.posts}</div>
              <div style="color:#777;font-size:0.9rem;">Publicaciones</div>
            </div>
            <div style="text-align:center;">
              <div style="font-size:2rem;color:#ba01ff;font-weight:900;">${data.recentActivity.likes}</div>
              <div style="color:#777;font-size:0.9rem;">Likes</div>
            </div>
            <div style="text-align:center;">
              <div style="font-size:2rem;color:#ba01ff;font-weight:900;">${data.recentActivity.comments}</div>
              <div style="color:#777;font-size:0.9rem;">Comentarios</div>
            </div>
          </div>
        </div>

        <h5 style="color:#5a189a;margin-bottom:16px;">üé§ Tus Artistas Favoritos</h5>
        <div style="display:grid;gap:12px;">
          ${data.topArtists.map((item, index) => `
            <div style="background:white;padding:16px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 8px rgba(0,0,0,0.05);">
              <div>
                <span style="color:#ba01ff;font-weight:700;margin-right:8px;">#${index + 1}</span>
                <span style="color:#333;">${item.artist}</span>
              </div>
              <span style="color:#777;font-size:0.9rem;">${Math.round(item.score)} puntos</span>
            </div>
          `).join('')}
        </div>
      `;

    } catch (err) {
      console.error('Error:', err);
      container.innerHTML = '<div class="alert alert-danger">Error al cargar an√°lisis</div>';
    }
  }

  // ===== HELPERS =====
  function crearPublicacionSimple(pub) {
    const article = document.createElement('article');
    article.className = 'publicacion-item mb-4 fade-in';
    article.innerHTML = `
      <div style="background:white;padding:20px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.05);">
        <strong style="color:#5a189a;">@${pub.usuario}</strong>
        <p style="margin:12px 0;color:#333;">${pub.publicacion}</p>
        ${pub.cancion ? `
          <div style="background:#f3e8ff;padding:12px;border-radius:8px;margin-top:12px;">
            <strong style="color:#ba01ff;">üéµ ${pub.cancion}</strong>
            <div style="color:#777;font-size:0.9rem;">${pub.artista}</div>
          </div>
        ` : ''}
      </div>
    `;
    return article;
  }

  function crearTarjetaUsuario(user) {
    const div = document.createElement('div');
    div.className = 'mb-3';
    div.innerHTML = `
      <div style="background:white;padding:20px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.05);display:flex;justify-content:space-between;align-items:center;">
        <div style="display:flex;align-items:center;gap:12px;">
          ${user.foto ? 
            `<img src="${user.foto}" style="width:50px;height:50px;border-radius:50%;object-fit:cover;">` :
            `<div style="width:50px;height:50px;border-radius:50%;background:#ba01ff;color:white;display:flex;align-items:center;justify-content:center;font-weight:700;">${user.usuario.charAt(0).toUpperCase()}</div>`
          }
          <div>
            <strong style="color:#5a189a;">@${user.usuario}</strong>
            ${user.artistas_comunes ? `<div style="color:#777;font-size:0.85rem;">${user.artistas_comunes} artistas en com√∫n</div>` : ''}
          </div>
        </div>
        <button class="btn btn-sm btn-ver-perfil-similar" data-id-usuario="${user.id_usuario}" style="background:#ba01ff;color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;">
          <i class="bi bi-eye"></i> Ver perfil
        </button>
      </div>
    `;
    
    // ‚úÖ Event listener para SPA
    const btnVerPerfil = div.querySelector('.btn-ver-perfil-similar');
    if (btnVerPerfil) {
      btnVerPerfil.addEventListener('click', function() {
        const idUsuario = this.getAttribute('data-id-usuario');
        if (typeof loadPage === 'function') {
          loadPage(`perfil-usuario.html?id=${idUsuario}`);
        } else {
          window.location.href = `perfil-usuario.html?id=${idUsuario}`;
        }
      });
    }
    
    return div;
  }

  // ===== EVENT LISTENERS =====
  document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
    tab.addEventListener('shown.bs.tab', (e) => {
      const target = e.target.getAttribute('data-bs-target');
      if (target === '#tab-publicaciones') cargarRecomendaciones();
      if (target === '#tab-usuarios') cargarUsuariosSimilares();
      if (target === '#tab-analisis') cargarAnalisis();
    });
  });

  // Cargar publicaciones al inicio
  cargarRecomendaciones();

})();
</script>
</body>
</html>