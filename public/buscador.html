<!-- public/busqueda.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Resultados de b√∫squeda - AttoMusic</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h2 class="search-results-title">üîé Resultados de b√∫squeda</h2>
  <h3 class="search-section-title">Canciones</h3>
  <div id="results-tracks" class="search-results"></div>
  <h3 class="search-section-title">Artistas</h3>
  <div id="results-artists" class="search-results"></div>
  <h3 class="search-section-title">√Ålbumes</h3>
  <div id="results-albums" class="search-results"></div>

  <script>
    async function runSearch() {
      // Usa window._searchParams si existe (SPA), si no usa window.location.search (acceso directo)
      const searchStr = typeof window._searchParams === 'string' ? window._searchParams : window.location.search;
      // Guarda los par√°metros de b√∫squeda globalmente para restaurar despu√©s
      window._searchParams = searchStr;
      const params = new URLSearchParams(searchStr);
      const q = params.get("q");
      const type = params.get("type") || "track,artist,album";

      if (!q) {
        document.getElementById("results-tracks").innerHTML = "<p>No se ingres√≥ b√∫squeda.</p>";
        document.getElementById("results-artists").innerHTML = "";
        document.getElementById("results-albums").innerHTML = "";
        return;
      }

      const res = await fetch(`https://attomusic.onrender.com/search?q=${encodeURIComponent(q)}&type=${type}`);
      const data = await res.json();

      mostrarTracks(data.tracks?.items || []);
      mostrarArtistas(data.artists?.items || []);
      mostrarAlbums(data.albums?.items || []);
    }

    function mostrarTracks(items) {
      const container = document.getElementById("results-tracks");
      container.innerHTML = "";
      if (items.length === 0) {
        container.innerHTML = "<p>No se encontraron canciones.</p>";
        return;
      }
      items.forEach(item => {
        const div = document.createElement("div");
        div.className = "search-card vertical-card";
        let img = "";
        if (item.album?.images?.[0]?.url) img = item.album.images[0].url;
        else if (item.images?.[0]?.url) img = item.images[0].url;
        if (img && img.startsWith('icono')) img = 'images/' + img;
        div.innerHTML = `
          <img src="${img}" alt="cover">
          <div class="card-info">
            <h3>${item.name}</h3>
            ${item.artists ? `<p>üë©‚Äçüé§ ${item.artists.map(a => a.name).join(", ")}</p>` : ""}
            ${item.album?.release_date ? `<p>üìÖ ${item.album.release_date}</p>` : ""}
            ${item.popularity !== undefined ? `<p>üî• Popularidad: ${item.popularity}</p>` : ""}
          </div>
        `;
        div.style.cursor = "pointer";
        div.addEventListener("click", () => {
          // Animaci√≥n: agranda la tarjeta seleccionada y desvanece las dem√°s
          const allCards = Array.from(container.querySelectorAll('.search-card'));
          allCards.forEach(c => {
            if (c === div) {
              c.classList.add('selected');
              c.classList.remove('faded');
            } else {
              c.classList.remove('selected');
              c.classList.add('faded');
            }
          });
          setTimeout(() => {
            // Mostrar solo el detalle de la canci√≥n seleccionada
            container.innerHTML = '';
            mostrarDetalleCancion(item.id);
          }, 350);
        });
        container.appendChild(div);
      });
    }

    function mostrarArtistas(items) {
      const container = document.getElementById("results-artists");
      container.innerHTML = "";
      if (items.length === 0) {
        container.innerHTML = "<p>No se encontraron artistas.</p>";
        return;
      }
      items.forEach(item => {
        const div = document.createElement("div");
        div.className = "search-card vertical-card";
        let img = "";
        if (item.images?.[0]?.url) img = item.images[0].url;
        if (img && img.startsWith('icono')) img = 'images/' + img;
        div.innerHTML = `
          <img src="${img}" alt="cover">
          <div class="card-info">
            <h3>${item.name}</h3>
            <div style="display:flex;gap:18px;align-items:center;flex-wrap:wrap;justify-content:center;">
              ${item.followers?.total ? `<span style='display:inline-flex;align-items:center;gap:4px;'><span style='font-size:1.2em;'>üë•</span> Seguidores: ${item.followers.total}</span>` : ""}
              ${item.popularity !== undefined ? `<span style='display:inline-flex;align-items:center;gap:4px;'><span style='font-size:1.2em;'>üî•</span> Popularidad: ${item.popularity}</span>` : ""}
            </div>
          </div>
        `;
        container.appendChild(div);
      });
    }

    function mostrarAlbums(items) {
      const container = document.getElementById("results-albums");
      container.innerHTML = "";
      if (items.length === 0) {
        container.innerHTML = "<p>No se encontraron √°lbumes.</p>";
        return;
      }
      items.forEach(item => {
        const div = document.createElement("div");
        div.className = "search-card vertical-card";
        let img = "";
        if (item.images?.[0]?.url) img = item.images[0].url;
        if (img && img.startsWith('icono')) img = 'images/' + img;
        div.innerHTML = `
          <img src="${img}" alt="cover">
          <div class="card-info">
            <h3>${item.name}</h3>
            ${item.artists ? `<p>üë©‚Äçüé§ ${item.artists.map(a => a.name).join(", ")}</p>` : ""}
            ${item.release_date ? `<p>üìÖ ${item.release_date}</p>` : ""}
          </div>
        `;
        container.appendChild(div);
      });
    }

    function mostrarDetalleCancion(id) {
      // Ocupa todo el espacio del contenedor principal
      const mainContent = document.getElementById("main-content") || document.body;
      mainContent.innerHTML = `<div class='detalle-cancion-container' style='width:100%;height:100%;display:flex;justify-content:center;align-items:center;'><div class='search-card vertical-card' id='detalle-cancion' style='max-width:400px;width:100%;margin:auto;'></div></div>`;
      const detalle = document.getElementById('detalle-cancion');
      detalle.innerHTML = `<div style='text-align:center;color:#5a189a;font-size:1.5rem;'>Cargando...</div>`;
      fetch(`https://attomusic.onrender.com/track/${id}`)
        .then(res => res.json())
        .then(track => {
          let img = track.album?.images?.[0]?.url || "";
          detalle.innerHTML = `
            <button id='volver-btn' class='btn btn-outline-primary' style='margin-bottom:18px;background:linear-gradient(160deg,#ba01ff,#00dffc);color:white;border:none;'>‚üµ Volver a resultados</button>
            <h2 style='color:#5a189a;'>${track.name}</h2>
            ${img ? `<img src='${img}' alt='cover' style='width:180px;height:180px;border-radius:12px;margin-bottom:12px;'>` : ""}
            <p style='color:#ba01ff;font-weight:700;'>üë©‚Äçüé§ ${track.artists.map(a => a.name).join(", ")}</p>
            <p>üíø √Ålbum: ${track.album?.name || ""}</p>
            <p>üìÖ ${track.album?.release_date || ""}</p>
            <p>üî• Popularidad: ${track.popularity}</p>
            <div style='margin-top:18px;'>
              <h4 style='color:#ba01ff;'>Califica esta canci√≥n</h4>
              <form id='calificar-form'>
                <input type='number' id='calificacion' min='1' max='5' required style='width:60px;border-radius:8px;border:1px solid #ba01ff;'>
                <button type='submit' class='btn btn-primary' style='margin-left:10px;background:linear-gradient(160deg,#ba01ff,#00dffc);border:none;'>Enviar</button>
              </form>
              <div id='calificacion-result'></div>
            </div>
            <div style='margin-top:18px;'>
              <h4 style='color:#5a189a;'>Deja un comentario</h4>
              <form id='comentario-form'>
                <textarea id='comentario' rows='3' required style='width:100%;border-radius:8px;border:1px solid #5a189a;padding:8px;'></textarea>
                <button type='submit' class='btn btn-primary' style='margin-top:10px;background:linear-gradient(160deg,#5a189a,#00dffc);border:none;width:100%;'>Enviar comentario</button>
              </form>
              <div id='comentario-result'></div>
            </div>
          `;
          document.getElementById('volver-btn').onclick = () => {
            // Restaurar los resultados de b√∫squeda usando los par√°metros guardados
            const mainContent = document.getElementById("main-content") || document.body;
            if (window._searchParams) {
              // Limpia el mainContent y vuelve a ejecutar la b√∫squeda
              mainContent.innerHTML = `
                <h2 class=\"search-results-title\">üîé Resultados de b√∫squeda</h2>
                <h3 class=\"search-section-title\">Canciones</h3>
                <div id=\"results-tracks\" class=\"search-results\"></div>
                <h3 class=\"search-section-title\">Artistas</h3>
                <div id=\"results-artists\" class=\"search-results\"></div>
                <h3 class=\"search-section-title\">√Ålbumes</h3>
                <div id=\"results-albums\" class=\"search-results\"></div>
              `;
              runSearch();
            } else {
              // Si no hay par√°metros, recarga la p√°gina (fallback)
              window.location.reload();
            }
          };
          document.getElementById("calificar-form").addEventListener("submit", function(e) {
            e.preventDefault();
            const val = document.getElementById("calificacion").value;
            document.getElementById("calificacion-result").innerHTML = `<p style='color:#5a189a;'>¬°Gracias! Calificaste esta canci√≥n con <b>${val}</b> estrellas.</p>`;
          });
          document.getElementById("comentario-form").addEventListener("submit", function(e) {
            e.preventDefault();
            const comentario = document.getElementById("comentario").value.trim();
            if (comentario) {
              document.getElementById("comentario-result").innerHTML = `<p style='color:#5a189a;'>¬°Gracias por tu comentario!</p><div style='background:#f3e8ff;border-radius:8px;padding:10px;margin-top:6px;color:#5a189a;'>${comentario}</div>`;
              document.getElementById("comentario").value = "";
            }
          });
        });
    }

    runSearch();
  </script>
</body>
</html>
