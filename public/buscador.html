<!-- public/buscador.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Resultados de b√∫squeda - AttoMusic</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <button id="backToTopBtn" title="Volver arriba" style="display:none;position:fixed;bottom:32px;right:32px;z-index:9999;background:linear-gradient(160deg,#ba01ff,#00dffc);color:white;border:none;border-radius:50%;width:52px;height:52px;box-shadow:0 2px 12px #0002;font-size:2rem;cursor:pointer;transition:opacity 0.3s;">
    <span style="display:inline-block;transform:translateY(-2px);">‚Üë</span>
  </button>
  
  <div id="main-content">
    <h2 class="search-results-title">üîé Resultados de b√∫squeda</h2>
    <h3 class="search-section-title">Canciones</h3>
    <div id="results-tracks" class="search-results"></div>
    <h3 class="search-section-title">Artistas</h3>
    <div id="results-artists" class="search-results"></div>
    <h3 class="search-section-title">√Ålbumes</h3>
    <div id="results-albums" class="search-results"></div>
  </div>

  <!-- IMPORTAR EL M√ìDULO REUTILIZABLE -->
  <script src="js/detalleCancion.js"></script>

  <script>
    // FUNCI√ìN INIT PARA REINICIALIZAR CADA VEZ
    (function initBuscador() {
      //console.log('Inicializando buscador...');
      
      // Inicializar m√≥dulo con email del usuario
      const userEmail = sessionStorage.getItem('userEmail') || sessionStorage.getItem('correo');
      DetalleCancion.init(userEmail);

      async function runSearch() {
        //console.log('Ejecutando b√∫squeda...');
        
        const searchStr = typeof window._searchParams === 'string' ? window._searchParams : window.location.search;
        window._searchParams = searchStr;
        const params = new URLSearchParams(searchStr);
        const q = params.get("q");
        const type = params.get("type") || "track,artist,album";

        //console.log('Query:', q);

        if (!q) {
          document.getElementById("results-tracks").innerHTML = "<p>No se ingres√≥ b√∫squeda.</p>";
          document.getElementById("results-artists").innerHTML = "";
          document.getElementById("results-albums").innerHTML = "";
          return;
        }

        try {
          const res = await fetch(`https://attomusic.onrender.com/spotify/search?q=${encodeURIComponent(q)}&type=${type}`);
          
          if (!res.ok) {
            throw new Error('Error en la b√∫squeda');
          }
          
          const data = await res.json();

          mostrarTracks(data.tracks?.items || []);
          mostrarArtistas(data.artists?.items || []);
          mostrarAlbums(data.albums?.items || []);
          
          //console.log(' B√∫squeda completada');
        } catch (error) {
          console.error(' Error en b√∫squeda:', error);
          document.getElementById("results-tracks").innerHTML = "<p style='color:red;'>Error al buscar. Intenta de nuevo.</p>";
        }
      }

      function mostrarTracks(items) {
        const container = document.getElementById("results-tracks");
        container.innerHTML = "";
        
        if (items.length === 0) {
          container.innerHTML = "<p>No se encontraron canciones.</p>";
          return;
        }
        
        items.forEach(item => {
          const div = document.createElement("div");
          div.className = "search-card vertical-card";
          let img = "";
          if (item.album?.images?.[0]?.url) img = item.album.images[0].url;
          else if (item.images?.[0]?.url) img = item.images[0].url;
          if (img && img.startsWith('icono')) img = 'images/' + img;
          
          div.innerHTML = `
            <img src="${img}" alt="cover">
            <div class="card-info">
              <h3>${item.name}</h3>
              ${item.artists ? `<p>üë©‚Äçüé§ ${item.artists.map(a => a.name).join(", ")}</p>` : ""}
              ${item.album?.release_date ? `<p>üìÖ ${item.album.release_date}</p>` : ""}
              ${item.popularity !== undefined ? `<p>üî• Popularidad: ${item.popularity}</p>` : ""}
            </div>
          `;
          div.style.cursor = "pointer";
          
          // USAR EL M√ìDULO REUTILIZABLE
          div.addEventListener("click", () => {
            DetalleCancion.mostrar(item.id, 'main-content', () => {
              // Callback para volver a resultados
              document.getElementById('main-content').innerHTML = `
                <h2 class="search-results-title">üîé Resultados de b√∫squeda</h2>
                <h3 class="search-section-title">Canciones</h3>
                <div id="results-tracks" class="search-results"></div>
                <h3 class="search-section-title">Artistas</h3>
                <div id="results-artists" class="search-results"></div>
                <h3 class="search-section-title">√Ålbumes</h3>
                <div id="results-albums" class="search-results"></div>
              `;
              runSearch();
            });
          });
          
          container.appendChild(div);
        });
      }

      function mostrarArtistas(items) {
        const container = document.getElementById("results-artists");
        container.innerHTML = "";
        
        if (items.length === 0) {
          container.innerHTML = "<p>No se encontraron artistas.</p>";
          return;
        }
        
        items.forEach(item => {
          const div = document.createElement("div");
          div.className = "search-card vertical-card";
          let img = "";
          if (item.images?.[0]?.url) img = item.images[0].url;
          if (img && img.startsWith('icono')) img = 'images/' + img;
          
          div.innerHTML = `
            <img src="${img}" alt="cover">
            <div class="card-info">
              <h3>${item.name}</h3>
              <div style="display:flex;gap:18px;align-items:center;flex-wrap:wrap;justify-content:center;">
                ${item.followers?.total ? `<span style='display:inline-flex;align-items:center;gap:4px;'><span style='font-size:1.2em;'>üë•</span> Seguidores: ${item.followers.total.toLocaleString()}</span>` : ""}
                ${item.popularity !== undefined ? `<span style='display:inline-flex;align-items:center;gap:4px;'><span style='font-size:1.2em;'>üî•</span> Popularidad: ${item.popularity}</span>` : ""}
              </div>
            </div>
          `;
          container.appendChild(div);
        });
      }

      function mostrarAlbums(items) {
        const container = document.getElementById("results-albums");
        container.innerHTML = "";
        
        if (items.length === 0) {
          container.innerHTML = "<p>No se encontraron √°lbumes.</p>";
          return;
        }
        
        items.forEach(item => {
          const div = document.createElement("div");
          div.className = "search-card vertical-card";
          let img = "";
          if (item.images?.[0]?.url) img = item.images[0].url;
          if (img && img.startsWith('icono')) img = 'images/' + img;
          
          div.innerHTML = `
            <img src="${img}" alt="cover">
            <div class="card-info">
              <h3>${item.name}</h3>
              ${item.artists ? `<p>üë©‚Äçüé§ ${item.artists.map(a => a.name).join(", ")}</p>` : ""}
              ${item.release_date ? `<p>üìÖ ${item.release_date}</p>` : ""}
            </div>
          `;
          container.appendChild(div);
        });
      }

      // EJECUTAR B√öSQUEDA AL CARGAR
      runSearch();
    })();
  </script>
</body>
</html>